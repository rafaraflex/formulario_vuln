<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitud de Servicios - Automatizaci√≥n</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 700px;
            margin: 0 auto;
            padding: 20px;
            background: #667eea;
            min-height: 100vh;
        }
        
        .form-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2563eb;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
        }
        
        button {
            background: #2563eb;
            color: white;
            padding: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
        }
        
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .required::after {
            content: " *";
            color: red;
        }

        .error-message {
            color: red;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        
        .debug-info {
            background: #f3f4f6;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h1 style="text-align: center; color: #2563eb; margin-bottom: 20px;">
            Solicitud de Servicios de Automatizaci√≥n
        </h1>
        
        <form id="automationForm">
            <!-- Informaci√≥n del Solicitante -->
            <div class="form-group">
                <label for="nombre" class="required">Nombre del solicitante</label>
                <input type="text" id="nombre" name="nombre" required>
                <div class="error-message" id="nombreError">
                    Por favor ingresa tu nombre
                </div>
            </div>
            
            <div class="form-group">
                <label for="email" class="required">Correo electr√≥nico</label>
                <input type="email" id="email" name="email" required>
                <div class="error-message" id="emailError">
                    Por favor ingresa un correo v√°lido
                </div>
            </div>
            
            <div class="form-group">
                <label for="cve" class="required">CVE (Clave √önica)</label>
                <input type="text" id="cve" name="cve" required>
                <div class="error-message" id="cveError">
                    Por favor ingresa tu CVE
                </div>
            </div>

            <!-- Configuraci√≥n de Automatizaci√≥n -->
            <div class="form-group">
                <label class="required">Opciones de automatizaci√≥n</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" name="dep_option" value="Ansible" id="ansible">
                        <label for="ansible">Ansible</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" name="dep_option" value="Packer" id="packer">
                        <label for="packer">Packer</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" name="dep_option" value="manual" id="manual">
                        <label for="manual">Manual</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" name="dep_option" value="Ansible Automation Platform" id="aap">
                        <label for="aap">Ansible Automation Platform</label>
                    </div>
                </div>
                <div class="error-message" id="depOptionError">
                    Selecciona al menos una opci√≥n
                </div>
            </div>

            <div class="form-group">
                <label for="target_iac_file" class="required">Nombre del Archivo Destino</label>
                <input type="text" id="target_iac_file" name="target_iac_file" required>
                <div class="error-message" id="targetIaCFileError">
                    Ingresa un nombre de archivo v√°lido
                </div>
            </div>

            <div class="form-group">
                <label for="nexus_url" class="required">URL del Repositorio Nexus</label>
                <input type="url" id="nexus_url" name="nexus_url" required>
                <div class="error-message" id="nexusUrlError">
                    Ingresa una URL v√°lida
                </div>
            </div>
            
            <button type="submit" id="submitBtn">
                Enviar Solicitud
            </button>
        </form>
        
        <div id="successMessage" style="display: none; background: #dbeafe; color: #2563eb; padding: 15px; border-radius: 5px; margin-top: 20px; text-align: center;">
            <h3>¬°Solicitud Enviada Exitosamente!</h3>
            <p>Hemos recibido tu solicitud. Te contactaremos pronto.</p>
        </div>
        
        <div id="errorMessage" style="display: none; background: #fee2e2; color: #dc2626; padding: 15px; border-radius: 5px; margin-top: 15px; text-align: center;">
            <p>Error al enviar el formulario. Intenta nuevamente.</p>
        </div>
        
        <!-- √Årea de debug -->
        <div class="debug-info">
            <strong>Informaci√≥n de Debug:</strong>
            <div id="debugOutput"></div>
        </div>
    </div>

    <script>
        function debugLog(message) {
            const debugOutput = document.getElementById('debugOutput');
            debugOutput.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
            console.log(message);
        }

        document.getElementById('automationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            debugLog("üîî EVENTO SUBMIT CAPTURADO");
            
            if (!validateForm()) {
                debugLog("‚ùå VALIDACI√ìN FALL√ì - FORMULARIO NO V√ÅLIDO");
                return;
            }
            
            debugLog("‚úÖ VALIDACI√ìN EXITOSA - ENVIANDO DATOS...");
            
            const submitBtn = document.getElementById('submitBtn');
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');
            
            // Ocultar mensajes anteriores
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';
            
            // Deshabilitar bot√≥n
            submitBtn.disabled = true;
            submitBtn.textContent = 'Enviando...';
            
            const formData = new FormData(this);
            const selectedOptions = formData.getAll('dep_option');
            
            const data = {
                nombre: formData.get('nombre').trim(),
                email: formData.get('email').trim(),
                cve: formData.get('cve').trim(),
                dep_option: selectedOptions,
                Target_IaC_File: formData.get('target_iac_file').trim(),
                Nexus_URL: formData.get('nexus_url').trim(),
                timestamp: new Date().toISOString(),
                fuente: 'formulario_automatizacion'
            };

            debugLog("üì¶ DATOS PREPARADOS: " + JSON.stringify(data));

            try {
                // URL del webhook de n8n
                const n8nWebhookUrl = 'https://pro-001-n8n.adnmou.easypanel.host/webhook-test/formulario-vuln';
                
                debugLog("üåê ENVIANDO A: " + n8nWebhookUrl);
                      
                const response = await fetch(n8nWebhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                debugLog("üì° RESPUESTA DEL SERVIDOR: " + response.status);
                
                if (response.ok) {
                    debugLog("‚úÖ ENV√çO EXITOSO");
                    successMessage.style.display = 'block';
                    document.getElementById('automationForm').reset();
                } else {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
            } catch (error) {
                debugLog("‚ùå ERROR: " + error.message);
                console.error('Error completo:', error);
                errorMessage.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Enviar Solicitud';
                debugLog("üîÑ BOT√ìN REHABILITADO");
            }
        });

        function validateForm() {
            let isValid = true;
            
            debugLog("üîç INICIANDO VALIDACI√ìN...");
            
            const requiredFields = ['nombre', 'email', 'cve', 'target_iac_file', 'nexus_url'];
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                const error = document.getElementById(fieldId + 'Error');
                
                debugLog(`Campo ${fieldId}: "${field.value}"`);
                
                if (!field.value.trim()) {
                    error.style.display = 'block';
                    isValid = false;
                    debugLog(`‚ùå Campo ${fieldId} est√° vac√≠o`);
                } else {
                    error.style.display = 'none';
                }
            });
            
            // Validar que al menos una opci√≥n est√© seleccionada
            const depOptions = document.querySelectorAll('input[name="dep_option"]:checked');
            const depOptionError = document.getElementById('depOptionError');
            debugLog(`Opciones seleccionadas: ${depOptions.length}`);
            
            if (depOptions.length === 0) {
                depOptionError.style.display = 'block';
                isValid = false;
                debugLog("‚ùå No hay opciones seleccionadas");
            } else {
                depOptionError.style.display = 'none';
            }
            
            debugLog(`üìä RESULTADO VALIDACI√ìN: ${isValid ? 'V√ÅLIDO' : 'INV√ÅLIDO'}`);
            return isValid;
        }

        // Validaci√≥n en tiempo real
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', function() {
                const errorElement = document.getElementById(this.id + 'Error');
                if (errorElement) {
                    errorElement.style.display = 'none';
                }
            });
        });

        debugLog("‚úÖ SCRIPT CARGADO CORRECTAMENTE");
    </script>
</body>
</html>
