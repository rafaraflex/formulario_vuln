<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitud de Servicios - Automatizaci√≥n</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 700px;
            margin: 0 auto;
            padding: 20px;
            background: #667eea;
            min-height: 100vh;
        }
        
        .form-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2563eb;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
        }
        
        button {
            background: #2563eb;
            color: white;
            padding: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
        }
        
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .required::after {
            content: " *";
            color: red;
        }

        .error-message {
            color: red;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        
        .success-message {
            display: none;
            background: #dbeafe;
            color: #2563eb;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            text-align: center;
        }
        
        .error-message-global {
            display: none;
            background: #fee2e2;
            color: #dc2626;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h1 style="text-align: center; color: #2563eb; margin-bottom: 20px;">
            Solicitud de Servicios de Automatizaci√≥n
        </h1>
        
        <form id="automationForm">
            <!-- Informaci√≥n del Solicitante -->
            <div class="form-group">
                <label for="nombre" class="required">Nombre del solicitante</label>
                <input type="text" id="nombre" name="nombre" required placeholder="Tu nombre completo">
                <div class="error-message" id="nombreError">
                    Por favor ingresa tu nombre
                </div>
            </div>
            
            <div class="form-group">
                <label for="email" class="required">Correo electr√≥nico</label>
                <input type="email" id="email" name="email" required placeholder="tu@email.com">
                <div class="error-message" id="emailError">
                    Por favor ingresa un correo v√°lido
                </div>
            </div>
            
            <div class="form-group">
                <label for="cve" class="required">CVE (Clave √önica)</label>
                <input type="text" id="cve" name="cve" required placeholder="CVE-2024-001">
                <div class="error-message" id="cveError">
                    Por favor ingresa tu CVE
                </div>
            </div>

            <!-- Configuraci√≥n de Automatizaci√≥n -->
            <div class="form-group">
                <label class="required">Opciones de automatizaci√≥n</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" name="dep_option" value="Ansible" id="ansible">
                        <label for="ansible">Ansible</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" name="dep_option" value="Packer" id="packer">
                        <label for="packer">Packer</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" name="dep_option" value="manual" id="manual">
                        <label for="manual">Manual</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" name="dep_option" value="Ansible Automation Platform" id="aap">
                        <label for="aap">Ansible Automation Platform</label>
                    </div>
                </div>
                <div class="error-message" id="depOptionError">
                    Selecciona al menos una opci√≥n
                </div>
            </div>

            <div class="form-group">
                <label for="target_iac_file" class="required">Nombre del Archivo Destino</label>
                <input type="text" id="target_iac_file" name="target_iac_file" required placeholder="infrastructure.yml">
                <div class="error-message" id="targetIaCFileError">
                    Ingresa un nombre de archivo v√°lido
                </div>
            </div>

            <div class="form-group">
                <label for="nexus_url" class="required">URL del Repositorio Nexus</label>
                <input type="url" id="nexus_url" name="nexus_url" required placeholder="https://nexus.example.com/repository/">
                <div class="error-message" id="nexusUrlError">
                    Ingresa una URL v√°lida
                </div>
            </div>
            
            <button type="submit" id="submitBtn">
                Enviar Solicitud
            </button>
        </form>
        
        <!-- Mensajes de √©xito y error -->
        <div id="successMessage" class="success-message">
            <h3>¬°Solicitud Enviada Exitosamente!</h3>
            <p>Hemos recibido tu solicitud. Te contactaremos pronto.</p>
        </div>
        
        <div id="errorMessage" class="error-message-global">
            <p>Error al enviar el formulario. Intenta nuevamente.</p>
        </div>
    </div>

    <script>
        document.getElementById('automationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log("üîî Formulario enviado");
            
            // Obtener referencias a los elementos ANTES de usarlos
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');
            const submitBtn = document.getElementById('submitBtn');
            
            // Verificar que los elementos existen
            if (!successMessage || !errorMessage || !submitBtn) {
                console.error("‚ùå No se encontraron algunos elementos:");
                console.log("successMessage:", successMessage);
                console.log("errorMessage:", errorMessage);
                console.log("submitBtn:", submitBtn);
                return;
            }
            
            // Ocultar mensajes anteriores
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';
            
            if (!validateForm()) {
                console.log("‚ùå Validaci√≥n fall√≥");
                return;
            }
            
            console.log("‚úÖ Validaci√≥n exitosa");
            
            // Deshabilitar bot√≥n
            submitBtn.disabled = true;
            submitBtn.textContent = 'Enviando...';
            
            const formData = new FormData(this);
            const selectedOptions = formData.getAll('dep_option');
            
            const data = {
                nombre: formData.get('nombre').trim(),
                email: formData.get('email').trim(),
                cve: formData.get('cve').trim(),
                dep_option: selectedOptions,
                Target_IaC_File: formData.get('target_iac_file').trim(),
                Nexus_URL: formData.get('nexus_url').trim(),
                timestamp: new Date().toISOString(),
                fuente: 'formulario_automatizacion'
            };

            console.log("üì¶ Datos a enviar:", data);

            try {
                // URL del webhook de n8n
                const n8nWebhookUrl = 'https://pro-001-n8n.adnmou.easypanel.host/webhook-test/formulario-vuln';
                
                console.log("üåê Enviando a:", n8nWebhookUrl);
                      
                const response = await fetch(n8nWebhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                console.log("üì° Respuesta del servidor:", response.status);
                
                if (response.ok) {
                    console.log("‚úÖ Env√≠o exitoso");
                    successMessage.style.display = 'block';
                    document.getElementById('automationForm').reset();
                } else {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
            } catch (error) {
                console.error("‚ùå Error:", error);
                errorMessage.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Enviar Solicitud';
            }
        });

        function validateForm() {
            let isValid = true;
            
            console.log("üîç Iniciando validaci√≥n...");
            
            const requiredFields = ['nombre', 'email', 'cve', 'target_iac_file', 'nexus_url'];
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                const error = document.getElementById(fieldId + 'Error');
                
                if (!field || !error) {
                    console.error(`‚ùå No se encontr√≥ campo o error: ${fieldId}`);
                    return;
                }
                
                console.log(`Campo ${fieldId}:`, field.value);
                
                if (!field.value.trim()) {
                    error.style.display = 'block';
                    isValid = false;
                    console.log(`‚ùå Campo ${fieldId} est√° vac√≠o`);
                } else {
                    error.style.display = 'none';
                }
            });
            
            // Validar que al menos una opci√≥n est√© seleccionada
            const depOptions = document.querySelectorAll('input[name="dep_option"]:checked');
            const depOptionError = document.getElementById('depOptionError');
            
            if (!depOptionError) {
                console.error("‚ùå No se encontr√≥ depOptionError");
                return false;
            }
            
            console.log(`Opciones seleccionadas: ${depOptions.length}`);
            
            if (depOptions.length === 0) {
                depOptionError.style.display = 'block';
                isValid = false;
                console.log("‚ùå No hay opciones seleccionadas");
            } else {
                depOptionError.style.display = 'none';
            }
            
            console.log(`üìä Resultado validaci√≥n: ${isValid ? 'V√ÅLIDO' : 'INV√ÅLIDO'}`);
            return isValid;
        }

        // Validaci√≥n en tiempo real
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', function() {
                const errorElement = document.getElementById(this.id + 'Error');
                if (errorElement) {
                    errorElement.style.display = 'none';
                }
            });
        });

        console.log("‚úÖ Script cargado correctamente");
    </script>
</body>
</html>
